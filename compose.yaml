version: '3.8'
services:
  postgres:
    image: postgres:14.1-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=mydatabase
      - POSTGRES_PASSWORD=secret
      - POSTGRES_USER=myuser
    ports:
      - 5432:5432
    volumes:
      - postgres_data:/var/lib/postgres
    networks:
      - local_network

  myapp:
    build: .
    restart: unless-stopped
    image: myapp:staging
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/mydatabase
      - SPRING_DATASOURCE_USERNAME=myuser
      - SPRING_DATASOURCE_PASSWORD=secret
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    ports:
      - 8080:8080
    depends_on:
      - postgres
      - temporal
    networks:
      - local_network

  temporal:
    depends_on:
      - postgres
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=myuser
      - POSTGRES_PWD=secret
      - POSTGRES_SEEDS=postgres
    image: temporalio/auto-setup:1.22.6
    networks:
      - local_network
    ports:
      - 7233:7233
    volumes:
      - temporal:/etc/temporal/config/dynamicconfig

volumes:
  postgres_data:
    driver: local
  temporal:
    driver: local

networks:
  local_network:
    driver: bridge